// Node 2: Pull ClickUp time entries (with team member inclusion)

  const CLICKUP_API_TOKEN = 'pk_230417947_6WHF3H6YTQBUPNXIDNYZRRLT8JQVQDCO';
  const TEAM_ID = '90151498763';

  const input = items[0].json;
  const startDate = Math.floor(Number(input.rangeStart));
  const endDate = Math.floor(Number(input.rangeEnd));

  // First, get all team members
  const teamRes = await this.helpers.httpRequest({
    method: 'GET',
    url: 'https://api.clickup.com/api/v2/team',
    headers: { 'Authorization': CLICKUP_API_TOKEN },
    json: true,
  });

  // Fetch all spaces to get project names
  var spaceLookup = {};
  try {
    var spacesRes = await this.helpers.httpRequest({
      method: 'GET',
      url: 'https://api.clickup.com/api/v2/team/' + TEAM_ID + '/space?archived=false',
      headers: { 'Authorization': CLICKUP_API_TOKEN },
      json: true,
    });
    var spaces = spacesRes.spaces || [];
    for (var s = 0; s < spaces.length; s++) {
      spaceLookup[spaces[s].id] = spaces[s].name;
    }
  } catch (err) {
    // Continue without space names if fetch fails
  }

  // Find our team and get member IDs
  var memberIds = [];
  for (var i = 0; i < teamRes.teams.length; i++) {
    if (teamRes.teams[i].id === TEAM_ID) {
      var members = teamRes.teams[i].members || [];
      for (var j = 0; j < members.length; j++) {
        memberIds.push(members[j].user.id);
      }
    }
  }

  // Fetch time entries for ALL team members
  var allTimeEntries = [];

  for (var k = 0; k < memberIds.length; k++) {
    var userId = memberIds[k];

    try {
      var res = await this.helpers.httpRequest({
        method: 'GET',
        url: 'https://api.clickup.com/api/v2/team/' + TEAM_ID + '/time_entries?start_date=' + startDate + '&end_date=' + endDate + '&assignee=' + userId,
        headers: { 'Authorization': CLICKUP_API_TOKEN },
        json: true,
      });

      var entries = res.data || [];
      for (var m = 0; m < entries.length; m++) {
        allTimeEntries.push(entries[m]);
      }
    } catch (err) {
      // Skip errors for individual users
    }
  }

  return [{
    json: {
      timeentries: allTimeEntries,
      spaceLookup: spaceLookup,
      _meta: {
        totalTimeEntries: allTimeEntries.length,
        teamMembersChecked: memberIds.length,
        spacesLoaded: Object.keys(spaceLookup).length,
        rangeStart: input.rangeStartISO,
        rangeEnd: input.rangeEndISO,
      }
    }
  }];