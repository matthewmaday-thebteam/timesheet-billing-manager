// Node 2: Pull ClickUp time entries with folder/space names for projects

const CLICKUP_API_TOKEN = 'pk_230417947_6WHF3H6YTQBUPNXIDNYZRRLT8JQVQDCO';
const TEAM_ID = '90151498763';

const input = items[0].json;
const startDate = Math.floor(Number(input.rangeStart));
const endDate = Math.floor(Number(input.rangeEnd));

// First, get all team members
const teamRes = await this.helpers.httpRequest({
  method: 'GET',
  url: 'https://api.clickup.com/api/v2/team',
  headers: { 'Authorization': CLICKUP_API_TOKEN },
  json: true,
});

// Build lookup maps for spaces and folders
var spaceLookup = {};
var folderLookup = {};

try {
  // Fetch all spaces
  var spacesRes = await this.helpers.httpRequest({
    method: 'GET',
    url: 'https://api.clickup.com/api/v2/team/' + TEAM_ID + '/space?archived=false',
    headers: { 'Authorization': CLICKUP_API_TOKEN },
    json: true,
  });

  var spaces = spacesRes.spaces || [];
  for (var s = 0; s < spaces.length; s++) {
    var space = spaces[s];
    spaceLookup[space.id] = space.name;

    // Fetch folders within each space
    try {
      var foldersRes = await this.helpers.httpRequest({
        method: 'GET',
        url: 'https://api.clickup.com/api/v2/space/' + space.id + '/folder?archived=false',
        headers: { 'Authorization': CLICKUP_API_TOKEN },
        json: true,
      });

      var folders = foldersRes.folders || [];
      for (var f = 0; f < folders.length; f++) {
        folderLookup[folders[f].id] = folders[f].name;
      }
    } catch (folderErr) {
      // Continue if folder fetch fails for a space
    }
  }
} catch (err) {
  // Continue without lookups if fetch fails
}

// Find our team and get member IDs
var memberIds = [];
for (var i = 0; i < teamRes.teams.length; i++) {
  if (teamRes.teams[i].id === TEAM_ID) {
    var members = teamRes.teams[i].members || [];
    for (var j = 0; j < members.length; j++) {
      memberIds.push(members[j].user.id);
    }
  }
}

// Fetch time entries for ALL team members
var allTimeEntries = [];

for (var k = 0; k < memberIds.length; k++) {
  var userId = memberIds[k];

  try {
    var res = await this.helpers.httpRequest({
      method: 'GET',
      url: 'https://api.clickup.com/api/v2/team/' + TEAM_ID + '/time_entries?start_date=' + startDate + '&end_date=' + endDate + '&assignee=' + userId,
      headers: { 'Authorization': CLICKUP_API_TOKEN },
      json: true,
    });

    var entries = res.data || [];
    for (var m = 0; m < entries.length; m++) {
      allTimeEntries.push(entries[m]);
    }
  } catch (err) {
    // Skip errors for individual users
  }
}

return [{
  json: {
    timeentries: allTimeEntries,
    spaceLookup: spaceLookup,
    folderLookup: folderLookup,
    _meta: {
      totalTimeEntries: allTimeEntries.length,
      teamMembersChecked: memberIds.length,
      spacesLoaded: Object.keys(spaceLookup).length,
      foldersLoaded: Object.keys(folderLookup).length,
      rangeStart: input.rangeStartISO,
      rangeEnd: input.rangeEndISO,
    }
  }
}];
