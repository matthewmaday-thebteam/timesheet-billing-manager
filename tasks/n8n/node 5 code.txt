// Node 5: Process ClickUp entries - use entry_id as unique task_id

var CLICKUP_TEAM_ID = "90151498763";
var syncedAt = new Date().toISOString();

function roundUpMinutesTo15FromSeconds(seconds) {
  var minutes = seconds / 60;
  return Math.ceil(minutes / 15) * 15;
}

var rows = [];

for (var i = 0; i < items.length; i++) {
  var e = items[i].json;

  if (!e.work_date) continue;
  if (!e.entry_id) continue;  // Must have unique entry_id

  var seconds = Number(e.duration_seconds || 0);
  if (!isFinite(seconds) || seconds <= 0) continue;

  var minutesRoundedUp = roundUpMinutesTo15FromSeconds(seconds);
  if (minutesRoundedUp <= 0) continue;

  rows.push({
    clockify_workspace_id: CLICKUP_TEAM_ID,
    work_date: e.work_date,
    project_id: e.space_id ? String(e.space_id) : null,
    project_name: e.project_name || "No Project",
    user_id: e.user_id,
    user_name: e.user_name || "Unknown",
    task_id: String(e.entry_id),  // USE entry_id - unique per time entry
    task_name: e.task_name || "No Task",
    total_minutes: minutesRoundedUp,
    synced_at: syncedAt,
  });
}

return [{ json: { rows: rows } }];
